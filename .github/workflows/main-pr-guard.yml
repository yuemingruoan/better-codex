name: Main PR Guard

on:
  pull_request_target:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - edited
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

jobs:
  source-branch-guard:
    name: Main PR source guard
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR source branch
        id: validate
        shell: bash
        run: |
          set -euo pipefail

          expected="develop-main"
          actual="${{ github.head_ref }}"

          echo "Expected head branch: $expected"
          echo "Actual head branch: $actual"

          if [[ "$actual" == "$expected" ]]; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Close unauthorized PR
        if: steps.validate.outputs.allowed != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.pull_request.number;
            const comment = [
              "This PR is automatically closed.",
              "Only `develop-main -> main` pull requests are allowed.",
              "该 PR 已自动关闭。仅允许 `develop-main -> main` 的合并请求。",
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment,
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issueNumber,
              state: "closed",
            });

      - name: Fail unauthorized PR
        if: steps.validate.outputs.allowed != 'true'
        shell: bash
        run: |
          echo "Only pull requests from develop-main to main are allowed."
          echo "仅允许 develop-main 向 main 发起 PR。"
          exit 1
