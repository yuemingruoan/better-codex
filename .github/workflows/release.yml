name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag name (e.g. v1.7.0) / 标签名（例如 v1.7.0）
        required: true
      target:
        description: Target commit/branch/sha / 目标提交/分支/哈希
        required: false
        default: main
      title:
        description: Release title (optional) / 发布标题（可选）
        required: false
      notes_file:
        description: Path to release notes file / 发布说明文件路径
        required: false
        default: docs/release/notes.md
      draft:
        description: Create as draft (true/false) / 作为草稿发布（true/false）
        required: false
        default: "false"
      prerelease:
        description: Mark as prerelease (true/false) / 标记为预发布（true/false）
        required: false
        default: "false"

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}
    env:
      CARGO_TERM_COLOR: always
    defaults:
      run:
        working-directory: codex-rs
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: codex-linux
            timeout: 40
          - os: macos-14
            artifact: codex-macos
            timeout: 75
          - os: windows-latest
            artifact: codex-windows
            timeout: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        continue-on-error: true
        with:
          workspaces: codex-rs -> target

      - name: Build codex binary
        run: cargo build --release -p codex-cli --bin codex --locked

      - name: Package artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          src="target/release/codex"
          dest="dist/${{ matrix.artifact }}"
          cp "$src" "$dest"
          tar -C dist -czf "${{ matrix.artifact }}.tar.gz" "${{ matrix.artifact }}"

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "target\\release\\codex.exe" "dist\\${{ matrix.artifact }}.exe" -Force
          Compress-Archive -Path "dist\\${{ matrix.artifact }}.exe" -DestinationPath "${{ matrix.artifact }}.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            codex-rs/${{ matrix.artifact }}.tar.gz
            codex-rs/${{ matrix.artifact }}.zip
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.notes_file }}" ]]; then
            echo "notes_file is required."
            exit 1
          fi
          if [[ ! -f "${{ inputs.notes_file }}" ]]; then
            echo "notes_file does not exist: ${{ inputs.notes_file }}"
            exit 1
          fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install update build dependencies
        run: npm install

      - name: Build better-codex update script
        run: npm run build:update

      - name: Prepare update script asset
        shell: bash
        run: |
          set -euo pipefail
          cp scripts/update/better-codex-update.js dist/better-codex-update.js

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t assets < <(find dist -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name 'better-codex-update.js' \))
          if [[ ${#assets[@]} -eq 0 ]]; then
            echo "No release assets found under dist/"
            exit 1
          fi
          args=(release create "${{ inputs.tag }}" --target "${{ inputs.target }}")
          if [[ -n "${{ inputs.title }}" ]]; then
            args+=(--title "${{ inputs.title }}")
          fi
          if [[ "${{ inputs.draft }}" == "true" ]]; then
            args+=(--draft)
          fi
          if [[ "${{ inputs.prerelease }}" == "true" ]]; then
            args+=(--prerelease)
          fi
          args+=(--notes-file "${{ inputs.notes_file }}")
          args+=("${assets[@]}")
          gh "${args[@]}"
